---
title: "Word Vectors Intro"
author: "Jonathan Fitzgerald & Sarah Connell"
date: "1/3/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Getting started

## Using this file

This file is an introduction to training and querying a model with word2vec; it provides a fairly detailed explanation of the entire process and is designed to be used with our class's RStudio Server instance. 

## Reminder on running code
To run a single line of code from an R Markdown file, put your cursor anywhere in that line of code and then hit `command-return` or `control-return.` If you want to run all of the code in a code snippet, you can hit the green triangle button on the right. If you want to run a particular section of code, select the section you want to run and hit `command-return` or `control-return`. 

You can also run code directly in the console (the window below where you are reading this) by typing or pasting it in and simply hitting `return`. You will get the same results, but if you want to save some code you've written, it's better to keep it in the R Markdown file, since that's more permanent. On the other hand, if you prefer to run some code but not make changes to your file, you can just run that in the console.

##Checking working directory
If this is a new RStudio session, you should check your working directory with the code below. As long as you opened this file from the WordVectors project, your working directory should be the right place: the "WordVectors" folder. If you do need to change your working directory, you can do so with the `setwd()` function.

```{r}

getwd()

```


## Loading packages
All the packages you will need for this exercise have been installed ahead of time, but you'll want to load them using the `library()` function if this is a new session. You'll have to load these packages every time you start a new session in RStudio.

```{r}

library(tidyverse)
library(tidytext)
library(magrittr)
library(devtools)
library(tsne)
library(wordVectors)

```

#Training models

## Reading in text files

The following script allows you to "read-in" multiple text files and combine them into a "tibble," which is a type of data table. Think of it as being like a spreadsheet, with rows and columns organizing information.

First, we get a list of the files to read-in (`fileList`), then we create a function (`readTextFiles`) to produce a tibble with two columns, `filename` and `text` for each text file in the folder. Then, we run the function to combine everything into one tibble called `combinedTexts`.

There are some special requirements when you want to run code that is defining functions; unlike most of the time, where you can put your cursor anywhere in the line of code to run it, you need to have your cursor either at the beginning or the end of the code defining your function when you run it (or just select the whole thing).

The *only* thing you'll need to change in the code below is the file path in the first line.

As long as you have the folder with your text files inside the `data` folder, you should only need to change the part after the slash (the part that reads "name_of_your_folder"). Remember that you can use `tab` to select the folder you want.

Make sure to change this one line *before* you run any of the code below. 

The code we will be using in this class is set up to require minimal editing on your part, but that does mean that you will need to have your input files in a very specific format. You need to have a set of .txt files all saved in the same folder (without any files in subfolders). To add a new folder to RStudio Server, you will need to compress that folder on your computer (create a zip file) and then upload it to the `data` folder with the `Upload` button near the top of the `Files` menu (make sure you are already inside the `data` folder when you do this!). 


```{r}

# Change "name_of_your_folder" to match the name of the folder with your corpus
path2file <- "data/HPtexts/"

# This will create a list of files in the folder
fileList <- list.files(path2file, full.names=TRUE) 

# This is where you define a function to read-in multiple texts and paste them into a tibble (remember that the code that defines functions must be run by putting your cursor at the beginning or end, or by selecting the whole section of code). You are only defining the function here; the next section of code is when you actually run the function.
readTextFiles <- function(file) { 
  message(file)
  rawText = paste(scan(file, sep="\n", what="raw", strip.white=TRUE))
  output = tibble(filename=gsub(path2file, "", file), text=rawText) %>% 
    group_by(filename) %>% 
    summarise(text = paste(rawText, collapse=" "))
  return(output)
}

# This is where you run the function to create a tibble of combined files called "combinedTexts"
combinedTexts <- tibble(filename=fileList) %>% 
  group_by(filename) %>% 
  do(readTextFiles(.$filename)) 

```

## Preparing text for word2vec
The section below defines several variables so that they can be called on in training your model. Working with general names (such as "w2vInput") for these variables lets you use them in the code that follows without having to change each instance; the first line is where you set up the specifics you need to distinguish one model from another.

You can pick any name you want in the first line of code below; make sure there are no spaces in the name you select and that it is descriptive enough that you will remember which model is which. 

The only line in the block of code below that you will need to change is the first one, but make sure to do this, or you will end up with a file called "your_file_name.bin"!


```{r}

# This section is where you define the variables you will be using to train your model; don't forget to change the text in the first line to whatever you want to call your model file
baseFile <- "your_file_nadffdmse"
w2vInput <- paste("data/",baseFile,".txt", sep = "")
w2vCleaned <- paste("data/",baseFile,"_cleaned.txt", sep="")
w2vBin <- paste("data/",baseFile,".bin", sep="")
combinedTexts$text %>% write_lines(w2vInput)

```


## Creating a vector space model

The code below is how you actually train your model. There are some parameters you might want to modify, or, if this is your first time training a model, you can also keep the defaults to start. 

You can adjust the number of processors to use on your computer in training the model with the `threads` parameter; this will impact how quickly the model is trained.

The `vectors` parameter allows you to change the dimensionality of your model to include more or fewer dimensions. Higher numbers of dimensions can make your model more precise, but will also increase both training time and the possibility of random errors. A value between 100 and 500 will work for most projects.

The `window` parameter allows you to control the number of words on either side of the target word that the model treats as relevant context; the smaller the window, the closer the context words will be.

The `iter` parameter allows you to control how many times your corpus is read through during model training. If your corpus is on the smaller side, then increasing the number of iterations can improve the reliability of your results.

The `negative_samples` parameter allows you to control the number of negative samples used in training; the model will take less time to train if you use this parameter to modify only a percentage of the weights for the non-context terms in your corpus over each iteration. For smaller datasets, a value between 5 and 20 is recommended; for larger ones, you can use smaller values, between 2 and 5.

For more on these parameters, and other options that you have in training a model, see the [code documentation](https://rdrr.io/github/bmschmidt/wordVectors/man/train_word2vec.html). 

You don't need to edit anything here the first time you train a model; just run the code one section at a time. When you begin working on your project, you should vary the parameters to see how they impact your results. 


```{r}
#This controls how much of your computer's processing power the code is allowed to use. 
THREADS <- 3

# prep_word2vec will prepare your corpus by creating a single text file and cleaning and lowercasing your text with the `tokenizers` package. If you set the value of `bundle_ngrams` to be greater than 1, it will automatically join common bigrams into a single word. 
prep_word2vec(origin=w2vInput, destination=w2vCleaned, lowercase=T, bundle_ngrams=1)

# The code below will train or read-in a model (note that if you want to overwrite an existing model, you will first need to delete the .bin file in your data folder or this code will just read-in the model you already have). See above on how you might modify the parameters before training your model. 
if (!file.exists(w2vBin)) {
  w2vModel <- train_word2vec(
    w2vCleaned,
    output_file=w2vBin,
    vectors=100,
    threads=THREADS,
    window=6, iter=10, negative_samples=15
  )
} else {
  w2vModel <- read.vectors(w2vBin)
}

```


#Querying the model

## Visualizing 

We can get a glimpse of what the model looks like by plotting it in two dimensions. Keep in mind that the model actually has many more dimensions, so we are, in effect, flattening it. Though the visualization is difficult to read, you should be able to see that similar words—words that are near each other in vector space—tend to clump together. The code below will likely take a minute or two to run, and your results will appear in the "Plots" window to the right (you can hit the "Zoom" button to get a better view).

```{r}

w2vModel %>% plot(perplexity=10)

```

## Clustering

The following script provides a way to cluster words that are near each other in vector space, using the "k-means" clustering algorithm. Below, we choose 150 `centers`, or 150 points around which to cluster words. Then we select ten random clusters and 15 words from each cluster to view. This code will also take a minute or two to run. You can change the number of centers, number of clusters to view, or the number of words to see—you can also increase the number of iterations (the number of times the algorithm should adjust where the centers are and where terms are positioned in relationship to those centers).


```{r}

centers <- 150
clustering <- kmeans(w2vModel,centers=centers,iter.max = 40)

sapply(sample(1:centers,10),function(n) {
  names(clustering$cluster[clustering$cluster==n][1:15])
})

```

## Closest to
Now that you've had a chance to think about the corpus as a whole, it's time to start investigating individual words. To find the words closest to a particular word in vector space, enter a term between the quotation marks and then run the code below. You'll notice the output shows up in the console. If you want to see more words, just increase the number. Make sure not to delete the quotation marks, and enter your word in lowercase. 

```{r}

w2vModel %>% closest_to('man', 10) 

```


## Closest to two things

You might also want to see the words closest to a combination of two (or more) words. Notice that this will open a new window with the results because of the `view()` function. If you prefer to see your results in this format, you can paste "%>% view()" at the end of the code above; or, if you prefer to see your results in the console, you can delete "%>% View()" from the code below. Note that the code below also shows just 20 results, instead of 30.

```{r}

w2vModel %>% closest_to(~"girl"+"woman", 20) %>% view()

```

## Closest to the space between two things
Or, you might want to look at the space between two terms, to see which words are similar to one term but not another: 

```{r}

w2vModel %>% closest_to(~'woman'-'man',20) 

```

## Analogies

You can even construct analogies, such as in the example below; these use vector math to subtract the contexts associated with one word from another (such as subtracting "man" from "king") and then add a third term (such as "woman"), which brings you to new vector space where you will find terms associated with the distinction between the first two terms *plus* the contexts of the third term.  Put more simply, this lets you ask questions like "man" is to "king" as "woman" is to *what*? In this example, we might expect to find the term "queen" as a result.

```{r}

w2vModel %>% closest_to(~"king"-"man"+"woman", 20)

```

# Working with other models and exporting results
## Reading in existing models

If you want to read-in a previously-trained model, you can do so with the code below (just replace "name_of_your_file" with the name of your file, and make sure you don't delete the .bin extension or the quotation marks). As long as you follow all of the instructions above about training your models and setting up the folders for your work in RStudio, all of your trained models will be saved as binary files (with a .bin extension) in your `data` folder. 

If you ever want to overwrite a model you've already trained (say, if you realize you need to change something in your input files and then train the model again), make sure to delete that model's .bin file first. 

You can also read-in models trained by others if you upload them to your `data` folder and then read them in with the code below. 

After you've restarted RStudio (in addition to checking your working directory and loading your packages), you'll also need to use the code below to read in your model again. 


```{r}

w2vModel = read.vectors("data/name_of_your_file.bin")

```

## Exporting queries
The code below will enable you to export the results from a particular query. To export query results, all you need to do is change the part after "w2vModel %>%" to match the query that you want to export. An example is filled in so that you can see what this looks like; to export the terms closest to a particular query term, you just need to change the text inside of the quotation marks. You can also adjust the number of words in the results set, if you want to see more or fewer. If you'd like to export results from a different query, such as addition or subtraction, just paste over the example query with the one that you want to export. 

The first line of code defines the variable "w2vExport" as whatever query you set. The second line actually exports a csv file (which you can open in any program on your computer that works with tabular data, including Excel and Numbers). You can call the file whatever you like by replacing the template text inside of the quotation marks. The csv file will be exported to the "output" folder in your current working directory, and it will overwrite existing files with the same name, so make sure to rename the export file if you want to keep earlier versions.

If you would like to then export the file from RStudio Server to your own computer, click the box next to the file to select it and then go to the "More" gear near the top of the Files menu. Then, choose "Export" and hit the "Download" button.

```{r}

w2vExport <- w2vModel %>% closest_to("girl", 30) 

#Change "name_of_your_query" to a descriptive name that you want to give to your export file.
write.csv(file="output/name_of_your_query.csv", x=w2vExport)


```

## Exporting clusters
You can use a similar method to export your clusters; the code below will first generate a set of clusters and then export a specified (by you) number of terms from those clusters. As above, you can change the number of centers and iterations when you are generating the clusters; you can also change how many sets of clusters and words from each cluster to export. The exporting mechanism is the same as with exporting queries above; you just change the language in the quotation marks to match the name that you want to give your file. 

```{r}
#Change "name_of_your_cluster" to a descriptive name that you want to give to your export file.
centers <- 150

clustering <- kmeans(w2vModel,centers=centers,iter.max = 40)

w2vExport <-sapply(sample(1:centers,150),function(n) {
  names(clustering$cluster[clustering$cluster==n][1:15])
})

write.csv(file="output/name_of_your_cluster.csv", x=w2vExport)

```

#Credit and thanks
This tutorial uses the `wordVectors` package developed by Ben Schmidt and Jian Li, itself based on the original `word2vec` code developed by Mikolov et al. The walkthrough was also informed by workshop materials authored by Schmidt, as well as by an exercise created by Thanasis Kinias and Ryan Cordell for the "Humanities Data Analysis" course.


---
title: "Word Vectors Installation"
author: "Jonathan Fitzgerald & Sarah Connell"
date: "1/3/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Getting started
## Downloading and Installing R and RStudio

If you are interested in working with R and RStudio directly on your computer, you can download R from the CRAN (Comprehensive R Archive Network) repository: https://cloud.r-project.org/. There are specific instructions for downloading to Linus, Mac OS X, and Windows machines.

To download RStudio see: https://rstudio.com/products/rstudio/download/.

You can read these instructions in the class RStudio Server instance, and then begin working on your own computer once you have downloaded everything. 


## Opening our folder and project

First, you should have downloaded the `WordVectors` folder from Dropbox. This file that you're reading now, `WordVectorsIntroRStudio.Rmd` should be inside the folder already, along with two folders called `data` and `output`. As with the work we did in RStudio Server, you will want to open the project file first, and then open the R Markdown files you want to work with. The difference in working with the RStudio Software directly is that the files you see in the *Files* view are those on your own computer. 

Going forward, when you open RStudio, it may also open this project. If it does not, however, you can open the project by going to `File` then `Open Project...` in the menu bar at the top of RStudio, or by clicking on the project file. Always check at the beginning of a session to make sure you have the project open; if you don't, it will likely cause errors.

##Checking working directory
If this is a new RStudio session, you should check your working directory with the code below. As long as you opened this file from the WordVectors project, your working directory should be the right place: the "WordVectors" folder. If you do need to change your working directory, you can do so with the `setwd()` function.

```{r}

getwd()

```

##Turning off inline code
Before running any code, you should do a quick check on your preferences for how RStudio will handle R Markdown files. Go to the RStudio menu above, then select Preferences, select "R Markdown Preferences," and make sure that "Show output inline for all R Markdown documents" is *not* selected. 


## Installing packages
*R Packages* are collections of functions, variables, data, and documentation that you can use to get options that go beyond what's available with the base R code. Like extensions for Google Chrome or Plugins on WordPress, these are additions that you can install directly from the internet through R's repository. Packages make it possible to do a wider range of tasks in R and are essential for working with word vectors. For more information about packages, you can explore this page from the R website: https://rstudio.com/products/rpackages/.

To install an R package, you can navigate through the Tool menu (Tools --> Install Packages) or install packages directly by running code with the `install()` function, as below. Whenever you are installing packages, make sure that you have an internet connection because the code pulls directly from online repositories.

Once you have installed a package on a computer you do not need to do so again.

Run each line of code below to install the packages you will need.

```{r}

install.packages("tidyverse")
install.packages("tidytext")
install.packages("magrittr")
install.packages("devtools")
install.packages("tsne")

```


## Loading packages
You will need to load in packages on your own computer, just as we did with R Studio Server. Every time that you start a new RStudio session, you will have to load the packages again. In general, you will want to make a habit of checking your working directory and loading necessary packages at the start of each session. To load the packages we will be using, run the following code:


```{r}

library(tidyverse)
library(tidytext)
library(magrittr)
library(devtools)
library(tsne)
# Hold off on running the line below, until you get to the next section 
library(wordVectors)

```


##Installing word2vec
Because the `wordVectors` package lives in GitHub, you will need to install it in a different way, using the `devtools()` function. That's why we had you pause before loading `wordVectors` above. After you've installed the `wordVectors` package (by running the code snippet below), you can ignore or even delete the comment above and just load all the packages at once. 

Make sure to load `wordVectors` after you install it; you can either scroll up and load it from the code block above, or you could try writing the code to load it yourself (either in the code block below or right in the console). 

```{r}

devtools::install_github('bmschmidt/wordVectors', force = TRUE)

```

#Training models
Once you have downloaded R and RStudio, and installed the packages, the rest of the code will run as you are used to from working in R Studio server:

## Reading in text files
The script below allows you to "read-in" multiple text files and combine them into a "tibble."

There are some special requirements when you want to run code that is defining functions; unlike most of the time, where you can put your cursor anywhere in the line of code to run it, you need to have your cursor either at the beginning or the end of the code defining your function when you run it (or just select the whole thing and run it).

The *only* thing you'll need to change in the code below is the file path in the first line.

As long as you have the folder with your text files inside the `data` folder, you should only need to change the part after the slash (the part that reads "name_of_your_folder"). Remember that you can use `tab` to select the folder you want.

Since you are working with the `data` folder on your own computer, you will need to move or save the folder with your text files into that folder, rather than uploading it as you did with RStudio Server.

```{r}

# Change "name_of_your_folder" to match the name of the folder with your corpus
path2file <- "data/name_of_your_folder"

# This will create a list of files in the folder
fileList <- list.files(path2file, full.names=TRUE) 

# This is where you define a function to read-in multiple texts and paste them into a tibble (remember that the code that defines functions must be run by putting your cursor at the beginning or end, or by selecting the whole section of code). You are only defining the function here; the next section of code is when you actually run the function.
readTextFiles <- function(file) { 
  message(file)
  rawText = paste(scan(file, sep="\n", what="raw", strip.white=TRUE))
  output = tibble(filename=gsub(path2file, "", file), text=rawText) %>% 
    group_by(filename) %>% 
    summarise(text = paste(rawText, collapse=" "))
  return(output)
}

# This is where you run the function to create a tibble of combined files called "combinedTexts"
combinedTexts <- tibble(filename=fileList) %>% 
  group_by(filename) %>% 
  do(readTextFiles(.$filename)) 

```

## Prepare Text for word2vec
You can pick any name you want in the first line of code below; make sure there are no spaces in the name you select and that it is descriptive enough that you will remember which model is which. 

The only line in the block of code below that you will need to change is the first one, but make sure to do this, or you will end up with a file called "your_file_name.bin"!


```{r}

# This section is where you define the variables you will be using to train your model; don't forget to change the text in the first line to whatever you want to call your model file
baseFile <- "your_file_name"
w2vInput <- paste("data/",baseFile,".txt", sep = "")
w2vCleaned <- paste("data/",baseFile,"_cleaned.txt", sep="")
w2vBin <- paste("data/",baseFile,".bin", sep="")
combinedTexts$text %>% write_lines(w2vInput)

```


## Create a Vector Space Model

The code below is how you actually train your model; for more on the specific parameters see the WordVectorsIntro R Markdown file. 


```{r}
#This controls how much of your computer's processing power the code is allowed to use. 
THREADS <- 3

# prep_word2vec will prepare your corpus by creating a single text file and cleaning and lowercasing your text with the `tokenizers` package. If you set the value of `bundle_ngrams` to be greater than 1, it will automatically join common bigrams into a single word. 
prep_word2vec(origin=w2vInput, destination=w2vCleaned, lowercase=T, bundle_ngrams=1)

# The code below will train or read-in a model
if (!file.exists(w2vBin)) {
  w2vModel <- train_word2vec(
    w2vCleaned,
    output_file=w2vBin,
    vectors=100,
    threads=THREADS,
    window=6, iter=10, negative_samples=15
  )
} else {
  w2vModel <- read.vectors(w2vBin)
}

```

#Querying the model

## Visualizing 

```{r}

w2vModel %>% plot(perplexity=10)

```

## Clustering


```{r}

centers <- 150
clustering <- kmeans(w2vModel,centers=centers,iter.max = 40)

sapply(sample(1:centers,10),function(n) {
  names(clustering$cluster[clustering$cluster==n][1:15])
})


```

## Closest to

```{r}

w2vModel %>% closest_to('man', 10) 

```


## Closest to two things

```{r}
w2vModel %>% closest_to(~"girl"+"woman", 20) %>% view()

```

## Closest to the space between two things

```{r}

w2vModel %>% closest_to(~'woman'-'man',20) 

```

## Analogies

```{r}

w2vModel %>% closest_to(~"king"-"man"+"woman", 20)

```

# Working with other models and exporting results
## Reading in existing models

If you want to read-in a previously-trained model, you can do so with the code below (just replace "name_of_your_file" with the name of your file, and make sure you don't delete the .bin extension or the quotation marks). As long as you follow all of the instructions above about training your models and setting up the folders for your work in RStudio, all of your trained models will be saved as binary files (with a .bin extension) in your `data` folder. 

If you ever want to overwrite a model you've already trained (say, if you realize you need to change something in your input files and then train the model again), make sure to delete that model's .bin file first. 

You can also read-in models trained by others if you save them to your `data` folder and then read them in with the code below. 

After you've restarted RStudio (in addition to checking your working directory and loading your packages), you'll also need to use the code below to read in your model again. 


```{r}

w2vModel = read.vectors("data/name_of_your_file.bin")

```

## Exporting queries
The code below will enable you to export the results from a particular query. To export query results, all you need to do is change the part after "w2vModel %>%" to match the query that you want to export. An example is filled in so that you can see what this looks like; to export the terms closest to a particular query term, you just need to change the text inside of the quotation marks. You can also adjust the number of words in the results set, if you want to see more or fewer. If you'd like to export results from a different query, such as addition or subtraction, just paste over the example query with the one that you want to export. 

The first line of code defines the variable "w2vExport" as whatever query you set. The second line actually exports a csv file (which you can open in any program on your computer that works with tabular data, including Excel and Numbers). You can call the file whatever you like by replacing the template text inside of the quotation marks. The csv file will be exported to the "output" folder in your current working directory, and it will overwrite existing files with the same name, so make sure to rename the export file if you want to keep earlier versions.

```{r}

w2vExport <- w2vModel %>% closest_to("girl", 30) 

#Change "name_of_your_query" to a descriptive name that you want to give to your export file.
write.csv(file="output/name_of_your_query.csv", x=w2vExport)


```

## Exporting clusters
You can use a similar method to export your clusters; the code below will first generate a set of clusters and then export a specified (by you) number of terms from those clusters. As above, you can change the number of centers and iterations when you are generating the clusters; you can also change how many sets of clusters and words from each cluster to export. The exporting mechanism is the same as with exporting queries above; you just change the language in the quotation marks to match the name that you want to give your file.  

```{r}
#Change "name_of_your_cluster" to a descriptive name that you want to give to your export file.
centers <- 150

clustering <- kmeans(w2vModel,centers=centers,iter.max = 40)

w2vExport <-sapply(sample(1:centers,150),function(n) {
  names(clustering$cluster[clustering$cluster==n][1:15])
})

write.csv(file="output/name_of_your_cluster.csv", x=w2vExport)

```

#Credit and thanks
This tutorial uses the `wordVectors` package developed by Ben Schmidt and Jian Li, itself based on the original `word2vec` code developed by Mikolov et al. The walkthrough was also informed by workshop materials authored by Schmidt, as well as by an exercise created by Thanasis Kinias and Ryan Cordell for the "Humanities Data Analysis" course.


